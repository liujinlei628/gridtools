#{extends 'main.html' /}
#{set title:'index.html' /}

<div class="row">
    <div class="col-lg-12">
        <div class="ibox float-e-margins" id="_qunee">
            <div class="ibox-content" style="overflow: hidden;padding-bottom: 0;">
                <h3>${busContent}</h3>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="ibox float-e-margins" id="_qunee">
            <div class="ibox-content" style="overflow: hidden;">
                <div id="crudListTable">
                    <table width="100%" class="table table-striped table-bordered table-hover tab tr th ">
                        <thead>
                            <tr>
                                <th width="5%">序号</th>
                                <th width="10%">业务对象</th>
                                <th width="40%">业务逻辑实体</th>
                                <th width="45%">业务物理实体</th>
                            </tr>
                        </thead>
                        <tbody>
                            #{list items:tempBusObjList,as:'_objVo'}
                            <tr>
                                <td>${_objVo_index}</td>
                                <td>${_objVo.tCfgBusinessObj.bus_obj_name}</td>
                                <td>
                                    <div>
                                        <div>
                                            <table width="100%" id="ywAttrTab" class="table table-striped table-bordered table-hover tab tr th ">
                                                <tr>
                                                    <th width="10%">序号</th>
                                                    <th width="75%">业务属性名称</th>
                                                    <th width="15%">操作</th>
                                                </tr>
                                                #{list items:_objVo.tCfgLogicalEntitieList,as:'_logicList'}
                                                   #{if _logicList.bus_attr_type == '0'}
                                                       <tr>
                                                            <td>${_logicList_index}</td>
                                                            <td>
                                                                <a href="javascript:void(0);" onclick="toBusDataLife('${_logicList.bus_attr_name}', '${_logicList.bus_attr_code}')" >${_logicList.bus_attr_name}</a>
                                                                <!-- ${_logicList.bus_attr_name} -->
                                                            </td>
                                                            <td>
                                                                <a href="javascript:void(0);" onclick="queryPhyEnByBusAttr('${_logicList.bus_attr_code}', this)" >
                                                                    <img width="20px" height="20px" src="@{'/public/images/left_.jpg'}">
                                                                </a>
                                                            </td>
                                                        </tr>
                                                    #{/if}
                                                #{/list}
                                            </table>
                                        </div>
                                        <div>
                                            <table width="100%" id="czAttrTab" class="table table-striped table-bordered table-hover tab tr th ">
                                                <tr>
                                                    <th width="10%">序号</th>
                                                    <th width="75%">操作属性名称</th>
                                                    <th width="15%">操作</th>
                                                </tr>
                                                #{list items:_objVo.tCfgLogicalEntitieList,as:'_logicList'}
                                                   #{if _logicList.bus_attr_type == '1'}
                                                       <tr>
                                                            <td>${_logicList_index}</td>
                                                            <td>
                                                                <a href="#" >${_logicList.bus_attr_name}</a>
                                                            </td>
                                                            <td>
                                                                <a href="javascript:void(0);" onclick="queryPhyEnByBusAttr('${_logicList.bus_attr_code}', this)" >
                                                                    <img width="20px" height="20px" src="@{'/public/images/left_.jpg'}">
                                                                </a>
                                                            </td>
                                                        </tr>
                                                    #{/if}
                                                #{/list}
                                            </table>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div >
                                        <table width="100%" id="physicalEntityTab" class="table table-striped table-bordered table-hover tab tr th ">
                                            <tr id="phyicalTr" >
                                                <th width="10%">序号</th>
                                                <th width="10%">来源系统</th>
                                                <th width="20%">数据库表名</th>
                                                <th width="25%">数据项名称</th>
                                            </tr>
                                            #{list items:tCfgPhysicalEntitieList,as:'_phyicList'}
                                                <tr class="phyicalInfoTr" >
                                                    <td>${_phyicList_index}</td>
                                                    <td>${_phyicList.bus_sys_src}</td>
                                                    <td>${_phyicList.bus_table_name_en}</td>
                                                    <td>${_phyicList.bus_colnum_name}</td>
                                                </tr>
                                            #{/list}
                                        </table>
                                    </div>
                                </td>
                            </tr>
                            #{/list}
                        </tbody>
                    </table>
                </div>
                <div class="page-box">
                    <button class="next-page-btn page-box-row">
                        <a class="next-page-btn-a" href="javascript:void(window.history.go(-1));" >返回</a>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

#{set 'moreScripts'}
<script type="text/javascript" src="@{'/public/js/echarts.min.js'}"></script>
<script type="text/javascript" src="@{'/public/js/jquery-form.min.js'}"></script>
<script type="text/javascript" src="@{'/public/js/jquery.validate.min.js'}"></script>
<script type="text/javascript" src="@{'/public/js/plugins/jquery-ui/jquery-ui.min.js'}"></script>
<link href="@{'/public/js/plugins/jquery-ui/jquery-ui.min.css'}" rel="stylesheet">
<script type="text/javascript">

    function queryNodeInfoById(nodeId){
        var html = "<div id='dialog-window' title='业务信息'><iframe id='myFrame' src='/Summary/detail?id="+nodeId+"' frameBorder='0' style='border: 0;margin-bottom:-5px;margin-top:-3px;' scrolling='no' height='100%' width='100%'></iframe></div>";
        $(html).dialog($.extend({
            modal: true,
            width: 850,
            height: 500,
            closeOnEscape: false,
            draggable: false,
            resizable: false,
            'class': 'overflow-y:hidden',
            close: function(event, ui) {
              $(this).dialog("destroy"); 
            },
            buttons : [{
                html : "关闭",
                'class' : "btn btn-default btn-sm",
                click : function() {
                    $(this).dialog("close");
                }
            }]
        }));
    }
    
    function toEditById(nodeId){
        var html = "<div id='dialog-window' title='业务信息'><iframe id='myFrame' src='/Summary/form?id="+nodeId+"' frameBorder='0' style='border: 0;margin-bottom:-5px;margin-top:-3px;' scrolling='no' height='100%' width='100%'></iframe></div>";
        $(html).dialog($.extend({
            modal: true,
            width: 800,
            height: 500,
            closeOnEscape: false,
            draggable: false,
            resizable: false,
            'class': 'overflow-y:hidden',
            buttons : [{
                html : "确定",
                id:"addSubmitButton",
                'class' : "btn btn-primary btn-sm",
                click : function(btn) {
                    var myFrameWin = document.getElementById("myFrame").contentWindow;
                    var myForm = myFrameWin.document.getElementById("summaryForm");
                    var _this = this;
                    $(myForm).validate({
                        meta: "validate",
                        onsubmit:true,
                        onblur:false,
                        onkeyup :false,
                        rules: {
                            vendorName: {
                                required: true,
                                specialChart: true
                            },
                            errorCode: {
                                required: true,
                                specialChart: true
                            },
                            codeSeverity: {
                                required: true,
                                specialChart: true
                            }
                        },
                        submitHandler: function(){
                            ajaxSubmit(myForm);
                            $(_this).dialog("close");
                        },
                        invalidHandler: function(){
                            return false;
                        }
                    });
                    $(myForm).submit();
                }
            },{
                html : "取消",
                'class' : "btn btn-default btn-sm",
                click : function() {
                    $(this).dialog("close");
                }
            }],
            close: function(event, ui) {
                $(this).dialog("destroy"); 
            }
        }));
    }
    
    function addNodeInfo(){
        var html ='<div id="dialog-window" title="新增业务"><iframe id="myFrame" src="@{controllers.Summary.addOneNode(keyword)}" frameBorder="0" style="border: 0;margin-bottom:-5px;margin-top:-3px;" scrolling="no" height="100%" width="100%"></iframe></div>';
        $(html).dialog($.extend({
            modal: true,
            width: 800,
            height: 550,
            closeOnEscape: false,
            draggable: false,
            resizable: false,
            'class': 'overflow-y:hidden',
            close: function(event, ui) {
              $(this).dialog("destroy"); 
            },
            buttons : [{
                html : "确定",
                id:"addSubmitButton",
                'class' : "btn btn-primary btn-sm",
                click : function(btn) {
                    var myFrameWin = document.getElementById("myFrame").contentWindow;
                    var myForm = myFrameWin.document.getElementById("summaryForm");
                    var _this = this;
                    $(myForm).validate({
                        meta: "validate",
                        onsubmit:true,
                        onblur:false,
                        onkeyup :false,
                        rules: {
                            vendorName: {
                                required: true,
                                specialChart: true
                            },
                            errorCode: {
                                required: true,
                                specialChart: true
                            },
                            codeSeverity: {
                                required: true,
                                specialChart: true
                            }
                        },
                        submitHandler: function(){
                            if(ajaxSubmit(myForm)){
                                $(_this).dialog("close");
                            } else {
                                return false;
                            }
                        },
                        invalidHandler: function(){
                            return false;
                        }
                    });
                    $(myForm).submit();
                }
            },{
                html : "取消",
                'class' : "btn btn-default btn-sm",
                click : function() {
                    $(this).dialog("close");
                }
          }]
        }));
    }
    //一级业务新增
    function ajaxSubmit1(frm) {
        
        var dataPara = getFormJson(frm);
        $.ajax({
            url: frm.action,
            type: frm.method,
            async: false,
            data: dataPara,
            dataType:"json",
            success: function(data){
                if(data == '1'){
                    alert("操作成功！");
                    window.location.reload(true);
                } else {
                    alert("操作失败，请联系系统管理员！");
                }
            } 
        });
    }
    
    //将form中的值转换为键值对。
    function getFormJson(frm) {
        var o = {};
        var a = $(frm).serializeArray();
        $.each(a, function () {
            if (o[this.name] !== undefined) {
                if (!o[this.name].push) {
                    o[this.name] = [o[this.name]];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    }
    
    function cleanForm(){
        $("#searchForm").find("input").each(function(){
            $(this).val("");
        });
        $("#searchForm").find("select").each(function(){
            $(this).val("");
        });
    }
    
    function queryPhyEnByBusAttr(busAttrCode, obj){
        
        $(".text_color").each(function(){
            $(this).removeClass("text_color");
        });
        
        $(obj).parent().prev().addClass("text_color");
        
        if(busAttrCode != null && busAttrCode != ''){
            $.ajax({
                url:"/BusinessObjs/queryPhyEnByBusAttr",
                type:"post",
                data:{
                    "busAttrCode":busAttrCode
                },
                success:function(data){
                    var list = JSON.parse(data).list;
                    var html = "";
                    $(".phyicalInfoTr").each(function(){
                        $(this).remove();
                    });
                    html +="<tr class='phyicalInfoTr' >";
                    for(var i = 0 ; i < list.length ; i ++){
                        var str = "<td>" + (i+1) + "</td>" + 
                            "<td>" + list[i].bus_sys_src + "</td>" + 
                            "<td>" + list[i].bus_table_name_en + "</td>" + 
                            "<td>" + list[i].bus_colnum_name + "</td>";
                        html += str;
                    }
                    html += "</tr>";
                    $("#phyicalTr").after(html);
                }
            });
        }
    }
    
    function toBusDataLife(busAttrName, busAttrCode){
    	
    	window.location.href = "/Businessobjs/toBusDataLife?busAttrName=" + busAttrName + "&busAttrCode=" + busAttrCode;
    }
    
</script>

<script type="text/javascript">

$(function(){
    showHighLight(2, 2, 5);
});

</script>

<style type="text/css">

.text_color {
    color:"#F30";
    font-weight: 600;
}


table tr th {
    text-align: center;
}

</style>

#{/set}
